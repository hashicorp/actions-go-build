#!/usr/bin/env bash

# shellcheck disable=SC2207 # I want BIN_RESULTS and ZIP_RESULTS to word-split into arrays.

source scripts/standard_header.bash
source scripts/digest_tools.bash

PASSED=true
BIN_PASSED=true
ZIP_PASSED=true

BIN_RESULTS=($(compare_digest "bin")) || { PASSED=false; BIN_PASSED=false; }
ZIP_RESULTS=($(compare_digest "zip")) || { PASSED=false; ZIP_PASSED=false; }

# Execute 'true' or 'false' on exit to set the correct exit code.
trap '$PASSED' EXIT

write_summary() { echo "$*" >> "${GITHUB_STEP_SUMMARY:-github-step-summary.md}"; }

emoji_for_passed() { "$1" && echo ":white_check_mark:" || echo ":x:"; }

BIN_HEADER="Binary $(emoji_for_passed $BIN_PASSED)"
ZIP_HEADER="Zip $(emoji_for_passed $ZIP_PASSED)"

write_summary "### Local Verification Build $(emoji_for_passed $PASSED)"
write_summary ""
write_summary "|     $BIN_HEADER     |     $ZIP_HEADER     |"
write_summary "|---------------------|---------------------|"
write_summary "| ${BIN_RESULTS[0]}   | ${ZIP_RESULTS[0]}   |"
write_summary "| ${BIN_RESULTS[1]:-} | ${ZIP_RESULTS[1]:-} |"
