# Reproducible Build Action

**This repo is WIP; not ready for use yet.**

The aim of this action is to allow defining a build in such a way that we are able
to attempt to repeat that build and compare the results to ensure that we get the
same built artifact(s) each time.

More documentation to follow as implementation progresses.

This is for internal HashiCorp use only; Internal folks please refer to RFC ENGSRV-084 for more details.

## What does it do?

Currently only supports pure Go projects.

1. **Installs Specified Go version**
1. **Primary Build:**
	1. Executes your build instructions in the default checkout directory.
	1. Zips and uploads the results as GitHub Actions artifacts using standard HashiCorp artifact names.
1. **Local Verification Build:**
	1. Executes your build instructions again in a different directory, at a later time.
	1. Zips and uploads the results as GitHub Actions artifacts labelled "local-verification-build".
1. **Compares Build Outputs:**
	1. Compares the SHA256 sums of your compiled binary artifacts from both builds.
	1. Compares the SHA256 sums of your zip file artifacts from both builds.
	1. Fails the build if either produce a mismatch, succeds otherwise.

## Usage

### Inputs

<!-- insert:scripts/codegen/inputs_doc -->
|  Name (* = required)  |  Description                                                                                                                           |
|  -----                |  -----                                                                                                                                 |
|  instructions *       |  Build instructions to generate the product binary at $BIN_PATH; See the docs for more info.                                           |
|  go_version *         |  Version of Go to use for this build.                                                                                                  |
|  product_version *    |  Version of the product being built. Exported as PRODUCT_VERSION.                                                                      |
|  os *                 |  Target product operating system. Exported as OS and GOOS.                                                                             |
|  arch *               |  Target product architecture. Exported as ARCH and GOARCH.                                                                             |
|  package_name *       |  Name of the package to build. Used to calculate default bin_name and zip_name. Exported as PACKAGE_NAME.                              |
|  bin_name             |  Name of the product binary generated by instructions. Defaults to package_name minus any '-enterprise' suffix. Exported as BIN_NAME.  |
|  zip_name             |  Name of the product zip file. Defaults to '${PACKAGE_NAME}_${PRODUCT_VERSION}_${OS}_${ARCH}.zip'. Exported as ZIP_NAME.               |
<!-- end:insert:scripts/codegen/inputs_doc -->

## TODO

- Store build metadata for external systems to use to reproduce the build.
- Support non-Go projects.
- See ENGSRV-083 for future plans.
