#!/bin/bash

set -Eeuo pipefail

log() { echo >&2 "$*"; }
die() { log "$(bold_red "FATAL: ") $(bold "$*")"; exit 1; }

ok() { log "$(bold_green "OK: $*")"; }

styled_text() { ATTR="$1"; shift; echo -en '\033['"${ATTR}m$*"'\033[0m'; }

bold()      { styled_text "1"    "$*"; }
blue()      { styled_text "94"   "$*"; }
bold_blue() { styled_text "1;94" "$*"; }
red()       { styled_text "91"   "$*"; }
bold_red()  { styled_text "1;91" "$*"; }
green()     { styled_text "92"   "$*"; }

DIR=".git/hook_tmp/pre-push"

test_in_isolation() {
	local REF="$1"
	shift
	rm -rf "$DIR"
	mkdir -p "$DIR"
	git clone . "$DIR"
	(
		cd "$DIR"
		git diff --exit-code || die "Unable to check $1 - unclean clone."
		git checkout "$REF"
		git diff --exit-code || die "Unable to check $1 - unclean checkout."
		"$@" || exit 1
	) || return 1
}

assert_no_diff_caused_by() {
	test_in_isolation "$@"
	(
		cd "$DIR"
		git diff --exit-code || exit 1
	) || return 1
}

# shellcheck disable=SC2021 # We want to replace square brackets.
zero="$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')"

while read -r _ local_oid _ remote_oid
do
	if test "$local_oid" = "$zero"
	then
		# Handle delete
		:
	else
		if test "$remote_oid" = "$zero"
		then
			# New branch, examine all commits
			range="$local_oid"
		else
			# Update to existing branch, examine new commits
			range="$remote_oid..$local_oid"
		fi

		# Check for version consistency.
		make version/check || die "Version check 'make check/version' failed."
		log "✓ Version check passed."

		CL_FILE="dev/changes/v$(cat dev/VERSION).md"
		# Check for changelog update.
		git diff --name-only "$range" | grep -qE "^$CL_FILE\$" || {
			die "No update to changelog file '$CL_FILE'"
		}
		log "✓ Changes logged in $CL_FILE"

		# Check docs are up-to-date.
		assert_no_diff_caused_by make docs || die "Docs are stale; please run 'make docs' and commit the changes."
		log "✓ Docs are up-to-date."
 
		# Check tests pass with commited changes.
		test_in_isolation  make test || die "Please ensure tests pass on this branch before pushingPlease."
		log "✓ Tests passed."

	fi
done

exit 0
