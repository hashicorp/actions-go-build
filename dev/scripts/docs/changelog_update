#!/usr/bin/env bash

set -Eeuo pipefail

REPO_URL="https://github.com/hashicorp/actions-go-build"

CL="CHANGELOG.md"
rm -f "$CL"

write() { echo "$*" >> "$CL"; }

write "<!--"
write "DO NOT EDIT THIS FILE MANUALLY; IT IS GENERATED BY 'make docs'"
write "Instead, edit the files in release/changes, then run 'make docs' to update this file."
write "-->"
write "# Changelog - Go Build Action"
write

find release/changes -type f -name '*.md' | sort | tac | while read -r FILE; do
	FILENAME="$(basename "$FILE")"
	VERSION="${FILENAME%.md}"
	DATE="$(git show -s --date="format:%B %d, %Y" --format=%cd "$VERSION")"
	write "## [$VERSION]($REPO_URL/releases/tag/$VERSION) - $DATE"
	write
	TAG="$VERSION"
	export REPO_URL TAG DATE
	write "$(envsubst < "$FILE")"
	write
done
