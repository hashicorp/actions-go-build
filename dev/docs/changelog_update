#!/usr/bin/env bash

set -Eeuo pipefail

REPO_URL="https://github.com/hashicorp/actions-go-build"

CL="CHANGELOG.md"
rm -f "$CL"

CHANGES_DIR="dev/changes"

write() { echo "$*" >> "$CL"; }

write "<!--"
write "DO NOT EDIT THIS FILE MANUALLY; IT IS GENERATED BY 'make docs'"
write "Instead, edit the files in $CHANGES_DIR/, then run 'make docs' to update this file."
write "-->"
write "# Changelog - Go Build Action"
write

LATEST=true

# First make sure we have our local tags matching those on the remote.
git fetch --force --tags

find "$CHANGES_DIR" -type f -name '*.md' | sort -V | tac | while read -r FILE; do
	FILENAME="$(basename "$FILE")"
	VERSION="${FILENAME%.md}"
	if "$LATEST"; then
		write "## Unreleased Changes (targeting $VERSION)"
		LATEST=false
	else
		DATE="$(git show -s --date="format:%B %d, %Y" --format=%cd "refs/tags/$VERSION")"
		write "## [$VERSION]($REPO_URL/releases/tag/$VERSION) - $DATE"
	fi
	write
	TAG="$VERSION"
	export REPO_URL TAG DATE
	write "$(envsubst < "$FILE")"
	write
done
